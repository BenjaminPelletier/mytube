<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>MyTube Remote</title>
    <link rel="stylesheet" href="{{ url_for('static', path='home.css') }}">
  </head>
  <body>
    <h1>MyTube Remote</h1>
    <p class="description">Kick off the featured recommendation on your Chromecast.</p>
    {% if playing %}
    <section class="now-playing">
      <p class="caption">Playing:</p>
      {% if playing.thumbnail_url %}
      <img class="thumbnail" src="{{ playing.thumbnail_url }}" alt="Thumbnail for {{ playing.title }}">
      {% endif %}
      <p class="title">{{ playing.title }}</p>
    </section>
    {% endif %}
    <section class="video-options" aria-live="polite"></section>
    <button id="refresh-videos" class="video-refresh" type="button" aria-label="Load new videos" hidden>ðŸ—˜</button>
    <p class="empty-state" id="video-empty">Loading videosâ€¦</p>
    {% if status %}
    <p class="status">{{ status }}</p>
    {% endif %}
    <div id="device-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="device-modal-title">
      <div class="modal-content">
        <h2 id="device-modal-title">Choose a device</h2>
        <p>Select a Chromecast device to begin casting.</p>
        <ul id="device-list"></ul>
        <button id="device-cancel" type="button">Cancel</button>
      </div>
    </div>
    <script>
      (() => {
        const videoContainer = document.querySelector(".video-options");
        const refreshButton = document.getElementById("refresh-videos");
        const emptyState = document.getElementById("video-empty");
        const videosApiUrl = "{{ videos_api_url }}";
        if (!videoContainer || !videosApiUrl) {
          return;
        }

        const modal = document.getElementById("device-modal");
        const deviceList = document.getElementById("device-list");
        const cancelButton = document.getElementById("device-cancel");
        let activeCastUrl = "";

        const hideModal = (resetActiveCastUrl = true) => {
          if (!modal) {
            return;
          }
          modal.classList.add("hidden");
          if (deviceList) {
            deviceList.innerHTML = "";
          }
          if (resetActiveCastUrl) {
            activeCastUrl = "";
          }
        };

        const redirectToCast = (targetUrl, device) => {
          if (!targetUrl) {
            return;
          }
          const url = new URL(targetUrl, window.location.origin);
          if (device) {
            url.searchParams.set("device", device);
          }
          window.location.href = url.toString();
        };

        const showModal = (devices) => {
          if (!modal || !deviceList) {
            redirectToCast(activeCastUrl);
            return;
          }
          deviceList.innerHTML = "";
          devices.forEach((device) => {
            const item = document.createElement("li");
            const button = document.createElement("button");
            button.type = "button";
            button.textContent = device;
            button.addEventListener("click", () => {
              hideModal(false);
              redirectToCast(activeCastUrl, device);
            });
            item.appendChild(button);
            deviceList.appendChild(item);
          });
          modal.classList.remove("hidden");
        };

        const handleCastClick = async (event) => {
          event.preventDefault();
          const option = event.currentTarget;
          if (!(option instanceof HTMLElement)) {
            return;
          }
          const targetUrl = option.getAttribute("data-cast-url") || option.getAttribute("href");
          if (!targetUrl) {
            return;
          }
          activeCastUrl = targetUrl;
          try {
            const response = await fetch("{{ devices_url }}");
            if (!response.ok) {
              throw new Error("Failed to load devices");
            }
            const payload = await response.json();
            const devices = Array.isArray(payload.devices) ? payload.devices : [];
            if (devices.length <= 1) {
              hideModal(false);
              redirectToCast(activeCastUrl, devices[0]);
              return;
            }
            showModal(devices);
          } catch (error) {
            console.error(error);
            hideModal(false);
            redirectToCast(activeCastUrl);
          }
        };

        const setLoadingState = (isLoading) => {
          if (refreshButton) {
            refreshButton.disabled = isLoading;
            if (isLoading) {
              refreshButton.setAttribute("aria-busy", "true");
            } else {
              refreshButton.removeAttribute("aria-busy");
            }
          }
          if (videoContainer) {
            videoContainer.setAttribute("aria-busy", String(isLoading));
          }
          if (emptyState && isLoading) {
            emptyState.textContent = "Loading videosâ€¦";
            emptyState.hidden = false;
          }
        };

        const renderVideos = (videos) => {
          videoContainer.innerHTML = "";
          const validVideos = Array.isArray(videos) ? videos : [];
          if (!validVideos.length) {
            if (emptyState) {
              emptyState.textContent = "No approved videos are available to cast.";
              emptyState.hidden = false;
            }
            return;
          }

          const fragment = document.createDocumentFragment();

          validVideos.forEach((video) => {
            if (!video || typeof video !== "object") {
              return;
            }
            const castUrl = typeof video.cast_url === "string" ? video.cast_url : "";
            const thumbnailUrl = typeof video.thumbnail_url === "string" ? video.thumbnail_url : "";
            const title = typeof video.title === "string" ? video.title : "";

            if (!castUrl || !thumbnailUrl || !title) {
              return;
            }

            const option = document.createElement("a");
            option.className = "video-option";
            option.href = castUrl;
            option.dataset.castUrl = castUrl;

            const thumbnail = document.createElement("img");
            thumbnail.className = "video-thumbnail";
            thumbnail.src = thumbnailUrl;
            thumbnail.alt = `Thumbnail for ${title}`;
            thumbnail.width = 320;

            const label = document.createElement("span");
            label.className = "video-title";
            label.textContent = title;

            option.appendChild(thumbnail);
            option.appendChild(label);
            option.addEventListener("click", handleCastClick);

            fragment.appendChild(option);
          });

          videoContainer.appendChild(fragment);

          if (emptyState) {
            emptyState.hidden = true;
          }
        };

        const loadVideos = async () => {
          setLoadingState(true);
          try {
            const response = await fetch(videosApiUrl, {
              headers: { Accept: "application/json" },
            });
            if (!response.ok) {
              throw new Error("Failed to load videos");
            }

            const payload = await response.json();
            renderVideos(payload.videos);
          } catch (error) {
            console.error(error);
            videoContainer.innerHTML = "";
            if (emptyState) {
              emptyState.textContent = "Unable to load videos.";
              emptyState.hidden = false;
            }
          } finally {
            setLoadingState(false);
            if (refreshButton) {
              refreshButton.hidden = false;
            }
          }
        };

        if (refreshButton) {
          refreshButton.addEventListener("click", () => {
            loadVideos();
          });
        }

        if (cancelButton) {
          cancelButton.addEventListener("click", () => {
            hideModal();
          });
        }

        if (modal) {
          modal.addEventListener("click", (event) => {
            if (event.target === modal) {
              hideModal();
            }
          });
        }

        loadVideos();
      })();
    </script>
  </body>
</html>
