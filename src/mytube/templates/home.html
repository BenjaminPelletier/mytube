<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>MyTube Remote</title>
    <link rel="stylesheet" href="{{ url_for('static', path='home.css') }}">
  </head>
  <body>
    <section class="now-playing" aria-live="polite" hidden>
      <p class="caption">Playing:</p>
      <img class="thumbnail" alt="" hidden>
      <p class="title" hidden></p>
      <p class="status-message" hidden></p>
      <div class="playback-controls" hidden>
        <button type="button" class="playback-button resume-button" aria-label="Resume video">‚ñ∂</button>
        <button type="button" class="playback-button pause-button" aria-label="Pause video">‚è∏</button>
        <button
          type="button"
          class="playback-button favorite-button"
          aria-label="Add to favorites"
          aria-pressed="false"
          disabled
        >‚ô°</button>
        <button
          type="button"
          class="playback-button flag-button"
          aria-label="Flag video"
          aria-pressed="false"
          disabled
        >‚öë</button>
      </div>
    </section>
    <section class="video-options" aria-live="polite">
      <button
        id="refresh-videos"
        class="video-option refresh-option"
        type="button"
        aria-label="Load more videos"
        hidden
      >
        <span class="refresh-icon" aria-hidden="true">üóò</span>
        <span class="refresh-label">More videos</span>
      </button>
    </section>
    <p class="empty-state" id="video-empty">Loading videos‚Ä¶</p>
    <script>
      (() => {
        const VIDEO_ID_PLACEHOLDER = "__VIDEO_ID__";
        const videoContainer = document.querySelector(".video-options");
        const refreshButton = document.getElementById("refresh-videos");
        const emptyState = document.getElementById("video-empty");
        const nowPlayingSection = document.querySelector(".now-playing");
        const nowPlayingCaption = nowPlayingSection
          ? nowPlayingSection.querySelector(".caption")
          : null;
        const nowPlayingTitle = nowPlayingSection ? nowPlayingSection.querySelector(".title") : null;
        const nowPlayingThumbnail = nowPlayingSection ? nowPlayingSection.querySelector(".thumbnail") : null;
        const nowPlayingStatus = nowPlayingSection ? nowPlayingSection.querySelector(".status-message") : null;
        const nowPlayingControls = nowPlayingSection ? nowPlayingSection.querySelector(".playback-controls") : null;
        const pauseButton = nowPlayingSection ? nowPlayingSection.querySelector(".pause-button") : null;
        const resumeButton = nowPlayingSection ? nowPlayingSection.querySelector(".resume-button") : null;
        const favoriteButton = nowPlayingSection ? nowPlayingSection.querySelector(".favorite-button") : null;
        const flagButton = nowPlayingSection ? nowPlayingSection.querySelector(".flag-button") : null;
        const videosApiUrl = "{{ videos_api_url }}";
        const playApiUrl = "{{ play_api_url }}";
        const pauseApiUrl = "{{ pause_api_url }}";
        const resumeApiUrl = "{{ resume_api_url }}";
        const favoriteApiTemplate = "{{ favorite_api_url }}";
        const flagApiTemplate = "{{ flag_api_url }}";

        const playbackCaptions = {
          playing: "Playing:",
          paused: "Paused:",
          playingPending: "Playing...",
          pausing: "Pausing...",
          resuming: "Resuming...",
        };

        let stableNowPlayingCaption = playbackCaptions.playing;

        const setNowPlayingCaption = (caption, { stable = false } = {}) => {
          if (!(nowPlayingCaption instanceof HTMLElement)) {
            return;
          }
          const text = caption || stableNowPlayingCaption || playbackCaptions.playing;
          nowPlayingCaption.textContent = text;
          if (stable) {
            stableNowPlayingCaption = text;
          }
        };

        const resetNowPlayingCaption = () => {
          setNowPlayingCaption(stableNowPlayingCaption);
        };

        const initialVideoId = (() => {
          const value = {{ play_video_id|tojson }};
          if (typeof value === "string") {
            return value.trim();
          }
          return "";
        })();

        const playbackButtons = [];
        if (pauseButton instanceof HTMLButtonElement) {
          playbackButtons.push(pauseButton);
        }
        if (resumeButton instanceof HTMLButtonElement) {
          playbackButtons.push(resumeButton);
        }

        const parseBoolean = (value) => value === true || value === "true";
        const buildVideoActionUrl = (template, videoId) => {
          if (!template || !videoId) {
            return "";
          }
          return template.replace(VIDEO_ID_PLACEHOLDER, encodeURIComponent(videoId));
        };

        const updateFavoriteButtonState = (isFavorite) => {
          if (!(favoriteButton instanceof HTMLButtonElement)) {
            return;
          }
          const active = Boolean(isFavorite);
          favoriteButton.textContent = active ? "‚ô•" : "‚ô°";
          favoriteButton.classList.toggle("is-favorite", active);
          favoriteButton.setAttribute("aria-pressed", active ? "true" : "false");
          favoriteButton.setAttribute(
            "aria-label",
            active ? "Remove from favorites" : "Add to favorites"
          );
        };

        const updateFlagButtonState = (isFlagged) => {
          if (!(flagButton instanceof HTMLButtonElement)) {
            return;
          }
          const active = Boolean(isFlagged);
          flagButton.classList.toggle("is-flagged", active);
          flagButton.setAttribute("aria-pressed", active ? "true" : "false");
          flagButton.setAttribute("aria-label", active ? "Unflag video" : "Flag video");
        };

        const setToggleButtonAvailability = (hasVideo) => {
          if (favoriteButton instanceof HTMLButtonElement) {
            if (!hasVideo) {
              favoriteButton.removeAttribute("aria-busy");
              updateFavoriteButtonState(false);
            }
            favoriteButton.disabled = !hasVideo;
          }
          if (flagButton instanceof HTMLButtonElement) {
            if (!hasVideo) {
              flagButton.removeAttribute("aria-busy");
              updateFlagButtonState(false);
            }
            flagButton.disabled = !hasVideo;
          }
        };

        const updateVideoOptionState = (videoId, property, isActive) => {
          if (!videoContainer || !videoId) {
            return;
          }
          const options = videoContainer.querySelectorAll(".video-option[data-video-id]");
          options.forEach((option) => {
            if (option instanceof HTMLElement && option.dataset.videoId === videoId) {
              option.dataset[property] = isActive ? "true" : "false";
            }
          });
        };

        const setPlaybackControlsDisabled = (isDisabled) => {
          playbackButtons.forEach((button) => {
            button.disabled = Boolean(isDisabled);
            if (isDisabled) {
              button.setAttribute("aria-busy", "true");
            } else {
              button.removeAttribute("aria-busy");
            }
          });
          if (!(nowPlayingSection instanceof HTMLElement)) {
            return;
          }
          const hasVideo = Boolean(nowPlayingSection.dataset.videoId);
          if (favoriteButton instanceof HTMLButtonElement) {
            if (isDisabled) {
              favoriteButton.disabled = true;
              favoriteButton.setAttribute("aria-busy", "true");
            } else {
              favoriteButton.removeAttribute("aria-busy");
              favoriteButton.disabled = !hasVideo;
            }
          }
          if (flagButton instanceof HTMLButtonElement) {
            if (isDisabled) {
              flagButton.disabled = true;
              flagButton.setAttribute("aria-busy", "true");
            } else {
              flagButton.removeAttribute("aria-busy");
              flagButton.disabled = !hasVideo;
            }
          }
        };

        if (!videoContainer || !videosApiUrl) {
          return;
        }

        const applyNowPlayingDetails = (details = {}) => {
          if (!nowPlayingSection) {
            return;
          }

          const title = typeof details.title === "string" ? details.title : "";
          const thumbnailUrl = typeof details.thumbnail_url === "string" ? details.thumbnail_url : "";
          const videoId = typeof details.video_id === "string" ? details.video_id : "";
          const favorite = parseBoolean(details.favorite);
          const flagged = parseBoolean(details.flagged);
          const hasVideo = Boolean(videoId);

          nowPlayingSection.hidden = false;
          nowPlayingSection.dataset.videoId = videoId;
          nowPlayingSection.dataset.favorite = favorite ? "true" : "false";
          nowPlayingSection.dataset.flagged = flagged ? "true" : "false";

          if (nowPlayingControls) {
            nowPlayingControls.hidden = !videoId;
          }

          if (nowPlayingTitle) {
            if (title) {
              nowPlayingTitle.textContent = title;
              nowPlayingTitle.hidden = false;
            } else {
              nowPlayingTitle.textContent = "";
              nowPlayingTitle.hidden = true;
            }
          }

          if (nowPlayingThumbnail) {
            if (thumbnailUrl) {
              nowPlayingThumbnail.src = thumbnailUrl;
              nowPlayingThumbnail.alt = title ? `Thumbnail for ${title}` : "Thumbnail";
              nowPlayingThumbnail.hidden = false;
            } else {
              nowPlayingThumbnail.removeAttribute("src");
              nowPlayingThumbnail.alt = "";
              nowPlayingThumbnail.hidden = true;
            }
          }

          updateFavoriteButtonState(hasVideo && favorite);
          updateFlagButtonState(hasVideo && flagged);
          setToggleButtonAvailability(hasVideo);
        };

        const setNowPlayingStatus = (message) => {
          if (!nowPlayingStatus) {
            return;
          }
          if (message) {
            nowPlayingStatus.textContent = message;
            nowPlayingStatus.hidden = false;
          } else {
            nowPlayingStatus.textContent = "";
            nowPlayingStatus.hidden = true;
          }
        };

        const setNowPlayingBusy = (isBusy) => {
          if (!nowPlayingSection) {
            return;
          }
          if (isBusy) {
            nowPlayingSection.setAttribute("aria-busy", "true");
          } else {
            nowPlayingSection.removeAttribute("aria-busy");
          }
          setPlaybackControlsDisabled(isBusy);
        };

        const extractErrorMessage = (payload, fallback) => {
          if (payload && typeof payload === "object") {
            const detail = payload.detail || payload.error || payload.message;
            if (typeof detail === "string" && detail) {
              return detail;
            }
          }
          return fallback;
        };

        const handlePlaybackControl = async ({
          apiUrl,
          fallbackMessage,
          pendingCaption,
          successCaption,
        } = {}) => {
          if (!apiUrl) {
            return;
          }

          setNowPlayingStatus("");
          if (pendingCaption) {
            setNowPlayingCaption(pendingCaption);
          }
          setNowPlayingBusy(true);

          try {
            const response = await fetch(apiUrl, {
              method: "POST",
              headers: { Accept: "application/json" },
            });

            let payload = null;
            try {
              payload = await response.json();
            } catch (error) {
              payload = null;
            }

            if (!response.ok) {
              const message = extractErrorMessage(
                payload,
                response.statusText || fallbackMessage
              );
              setNowPlayingStatus(message || fallbackMessage);
              resetNowPlayingCaption();
              return;
            }

            setNowPlayingStatus("");
            if (successCaption) {
              setNowPlayingCaption(successCaption, { stable: true });
            }
          } catch (error) {
            const message = error instanceof Error ? error.message : fallbackMessage;
            setNowPlayingStatus(message);
            console.error(error);
            resetNowPlayingCaption();
          } finally {
            setNowPlayingBusy(false);
          }
        };

        async function playVideo(videoId, pendingDetails = {}) {
          if (!videoId || !playApiUrl) {
            return;
          }

          const pendingTitle =
            typeof pendingDetails.title === "string" ? pendingDetails.title : "";
          const pendingThumbnail =
            typeof pendingDetails.thumbnail_url === "string"
              ? pendingDetails.thumbnail_url
              : "";
          const pendingFavorite = parseBoolean(pendingDetails.favorite);
          const pendingFlagged = parseBoolean(pendingDetails.flagged);

          const fallbackDetails = {
            title: pendingTitle,
            thumbnail_url: pendingThumbnail,
            video_id: videoId,
            favorite: pendingFavorite,
            flagged: pendingFlagged,
          };

          applyNowPlayingDetails(fallbackDetails);
          setNowPlayingStatus("");
          setNowPlayingCaption(playbackCaptions.playingPending);
          setNowPlayingBusy(true);

          try {
            const response = await fetch(playApiUrl, {
              method: "POST",
              headers: {
                Accept: "application/json",
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ video_id: videoId }),
            });

            let payload = null;
            try {
              payload = await response.json();
            } catch (error) {
              payload = null;
            }

            if (!response.ok) {
              const message = extractErrorMessage(
                payload,
                response.statusText || "Unable to play video."
              );
              setNowPlayingStatus(message);
              resetNowPlayingCaption();
              return;
            }

            if (payload && typeof payload === "object" && payload.playing) {
              const playingData = payload.playing;
              if (playingData && typeof playingData === "object") {
                applyNowPlayingDetails({
                  title:
                    typeof playingData.title === "string" && playingData.title
                      ? playingData.title
                      : fallbackDetails.title,
                  thumbnail_url:
                    typeof playingData.thumbnail_url === "string" && playingData.thumbnail_url
                      ? playingData.thumbnail_url
                      : fallbackDetails.thumbnail_url,
                  video_id:
                    typeof playingData.video_id === "string" && playingData.video_id
                      ? playingData.video_id
                      : fallbackDetails.video_id,
                  favorite:
                    typeof playingData.favorite === "boolean"
                      ? playingData.favorite
                      : fallbackDetails.favorite,
                  flagged:
                    typeof playingData.flagged === "boolean"
                      ? playingData.flagged
                      : fallbackDetails.flagged,
                });
              }
            }

            setNowPlayingStatus("");
            setNowPlayingCaption(playbackCaptions.playing, { stable: true });
          } catch (error) {
            const message = error instanceof Error ? error.message : "Unable to play video.";
            setNowPlayingStatus(message);
            console.error(error);
            resetNowPlayingCaption();
          } finally {
            setNowPlayingBusy(false);
          }
        }

        async function playVideoOptionElement(option) {
          if (!(option instanceof HTMLElement)) {
            return;
          }

          const videoId = option.dataset.videoId;
          if (!videoId) {
            return;
          }

          const pendingDetails = {
            title:
              option.dataset.videoTitle ||
              (option.querySelector(".video-title")?.textContent || ""),
            thumbnail_url:
              option.dataset.thumbnailUrl ||
              (option.querySelector(".video-thumbnail")?.getAttribute("src") || ""),
            favorite: parseBoolean(option.dataset.favorite),
            flagged: parseBoolean(option.dataset.flagged),
          };

          await playVideo(videoId, pendingDetails);
        }

        const handlePlayVideo = async (event) => {
          event.preventDefault();

          const option = event.currentTarget;
          if (!(option instanceof HTMLElement)) {
            return;
          }

          await playVideoOptionElement(option);
        };

        if (pauseButton instanceof HTMLButtonElement) {
          pauseButton.addEventListener("click", (event) => {
            event.preventDefault();
            void handlePlaybackControl({
              apiUrl: pauseApiUrl,
              fallbackMessage: "Unable to pause playback.",
              pendingCaption: playbackCaptions.pausing,
              successCaption: playbackCaptions.paused,
            });
          });
        }

        if (resumeButton instanceof HTMLButtonElement) {
          resumeButton.addEventListener("click", (event) => {
            event.preventDefault();
            void handlePlaybackControl({
              apiUrl: resumeApiUrl,
              fallbackMessage: "Unable to resume playback.",
              pendingCaption: playbackCaptions.resuming,
              successCaption: playbackCaptions.playing,
            });
          });
        }

        const appendRefreshCard = () => {
          if (!videoContainer || !refreshButton) {
            return;
          }
          videoContainer.appendChild(refreshButton);
        };

        const setLoadingState = (isLoading) => {
          if (refreshButton) {
            refreshButton.disabled = isLoading;
            if (isLoading) {
              refreshButton.setAttribute("aria-busy", "true");
            } else {
              refreshButton.removeAttribute("aria-busy");
            }
          }
          if (videoContainer) {
            videoContainer.setAttribute("aria-busy", String(isLoading));
          }
          if (emptyState && isLoading) {
            emptyState.textContent = "Loading videos‚Ä¶";
            emptyState.hidden = false;
          }
        };

        const renderVideos = (videos) => {
          videoContainer.innerHTML = "";
          const validVideos = Array.isArray(videos) ? videos : [];
          if (!validVideos.length) {
            if (emptyState) {
              emptyState.textContent = "No approved videos are available to cast.";
              emptyState.hidden = false;
            }
            appendRefreshCard();
            return;
          }

          const fragment = document.createDocumentFragment();

          validVideos.forEach((video) => {
            if (!video || typeof video !== "object") {
              return;
            }
            const videoId = typeof video.video_id === "string" ? video.video_id : "";
            const thumbnailUrl = typeof video.thumbnail_url === "string" ? video.thumbnail_url : "";
            const title = typeof video.title === "string" ? video.title : "";
            const isFavorite = Boolean(video.favorite);
            const isFlagged = Boolean(video.flagged);

            if (!videoId || !thumbnailUrl || !title) {
              return;
            }

            const option = document.createElement("a");
            option.className = "video-option";
            option.href = "#";
            option.setAttribute("role", "button");
            option.dataset.videoId = videoId;
            option.dataset.videoTitle = title;
            option.dataset.thumbnailUrl = thumbnailUrl;
            option.dataset.favorite = isFavorite ? "true" : "false";
            option.dataset.flagged = isFlagged ? "true" : "false";

            const thumbnail = document.createElement("img");
            thumbnail.className = "video-thumbnail";
            thumbnail.src = thumbnailUrl;
            thumbnail.alt = `Thumbnail for ${title}`;
            thumbnail.width = 320;

            const label = document.createElement("span");
            label.className = "video-title";
            label.textContent = title;

            option.appendChild(thumbnail);
            option.appendChild(label);
            option.addEventListener("click", handlePlayVideo);

            fragment.appendChild(option);
          });

          videoContainer.appendChild(fragment);
          appendRefreshCard();

          if (emptyState) {
            emptyState.hidden = true;
          }
        };

        async function loadVideos() {
          setLoadingState(true);
          try {
            const response = await fetch(videosApiUrl, {
              headers: { Accept: "application/json" },
            });
            if (!response.ok) {
              throw new Error("Failed to load videos");
            }

            const payload = await response.json();
            renderVideos(payload.videos);
          } catch (error) {
            console.error(error);
            videoContainer.innerHTML = "";
            appendRefreshCard();
            if (emptyState) {
              emptyState.textContent = "Unable to load videos.";
              emptyState.hidden = false;
            }
          } finally {
            setLoadingState(false);
            if (refreshButton) {
              refreshButton.hidden = false;
            }
          }
        }

        if (refreshButton) {
          refreshButton.addEventListener("click", () => {
            void loadVideos();
          });
        }

        if (favoriteButton instanceof HTMLButtonElement) {
          favoriteButton.addEventListener("click", async (event) => {
            event.preventDefault();
            if (!nowPlayingSection) {
              return;
            }
            const videoId = nowPlayingSection.dataset.videoId;
            if (!videoId) {
              return;
            }
            const requestUrl = buildVideoActionUrl(favoriteApiTemplate, videoId);
            if (!requestUrl) {
              return;
            }

            favoriteButton.disabled = true;
            favoriteButton.setAttribute("aria-busy", "true");

            try {
              const response = await fetch(requestUrl, {
                method: "POST",
                headers: { Accept: "application/json" },
              });

              let payload = null;
              try {
                payload = await response.json();
              } catch (error) {
                payload = null;
              }

              if (!response.ok || !payload || typeof payload.favorite !== "boolean") {
                const message = extractErrorMessage(
                  payload,
                  response.statusText || "Unable to update favorite."
                );
                setNowPlayingStatus(message || "Unable to update favorite.");
                return;
              }

              const isFavorite = Boolean(payload.favorite);
              nowPlayingSection.dataset.favorite = isFavorite ? "true" : "false";
              updateFavoriteButtonState(isFavorite);
              updateVideoOptionState(videoId, "favorite", isFavorite);
              setNowPlayingStatus("");
            } catch (error) {
              const message =
                error instanceof Error ? error.message : "Unable to update favorite.";
              setNowPlayingStatus(message);
              console.error(error);
            } finally {
              favoriteButton.removeAttribute("aria-busy");
              setToggleButtonAvailability(Boolean(nowPlayingSection.dataset.videoId));
            }
          });
        }

        if (flagButton instanceof HTMLButtonElement) {
          flagButton.addEventListener("click", async (event) => {
            event.preventDefault();
            if (!nowPlayingSection) {
              return;
            }
            const videoId = nowPlayingSection.dataset.videoId;
            if (!videoId) {
              return;
            }
            const requestUrl = buildVideoActionUrl(flagApiTemplate, videoId);
            if (!requestUrl) {
              return;
            }

            const wasFlagged = parseBoolean(nowPlayingSection.dataset.flagged);
            flagButton.disabled = true;
            flagButton.setAttribute("aria-busy", "true");

            try {
              const response = await fetch(requestUrl, {
                method: "POST",
                headers: { Accept: "application/json" },
              });

              let payload = null;
              try {
                payload = await response.json();
              } catch (error) {
                payload = null;
              }

              if (!response.ok || !payload || typeof payload.flagged !== "boolean") {
                const message = extractErrorMessage(
                  payload,
                  response.statusText || "Unable to update flag."
                );
                setNowPlayingStatus(message || "Unable to update flag.");
                return;
              }

              const isFlagged = Boolean(payload.flagged);
              nowPlayingSection.dataset.flagged = isFlagged ? "true" : "false";
              updateFlagButtonState(isFlagged);
              updateVideoOptionState(videoId, "flagged", isFlagged);
              setNowPlayingStatus("");

              if (isFlagged && !wasFlagged) {
                const firstOption = videoContainer?.querySelector(
                  ".video-option[data-video-id]"
                );
                if (firstOption instanceof HTMLElement) {
                  await playVideoOptionElement(firstOption);
                }
                await loadVideos();
              }
            } catch (error) {
              const message =
                error instanceof Error ? error.message : "Unable to update flag.";
              setNowPlayingStatus(message);
              console.error(error);
            } finally {
              flagButton.removeAttribute("aria-busy");
              setToggleButtonAvailability(Boolean(nowPlayingSection.dataset.videoId));
            }
          });
        }

        if (initialVideoId) {
          void playVideo(initialVideoId);
        }

        void loadVideos();
      })();
    </script>
  </body>
</html>
