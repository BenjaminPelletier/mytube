<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>MyTube Remote</title>
    <link rel="stylesheet" href="{{ url_for('static', path='home.css') }}">
  </head>
  <body>
    <h1>MyTube Remote</h1>
    <p class="description">Kick off the featured recommendation on your Chromecast.</p>
    {% if playing %}
    <section class="now-playing">
      <p class="caption">Playing:</p>
      {% if playing.thumbnail_url %}
      <img class="thumbnail" src="{{ playing.thumbnail_url }}" alt="Thumbnail for {{ playing.title }}">
      {% endif %}
      <p class="title">{{ playing.title }}</p>
    </section>
    {% endif %}
    {% if videos %}
    <section class="video-options">
      {% for video in videos %}
      <a class="video-option" href="{{ video.cast_url }}" data-cast-url="{{ video.cast_url }}">
        <img class="video-thumbnail" src="{{ video.thumbnail_url }}" alt="Thumbnail for {{ video.title }}" width="320">
        <span class="video-title">{{ video.title }}</span>
      </a>
      {% endfor %}
    </section>
    {% else %}
    <p class="empty-state">No approved videos are available to cast.</p>
    {% endif %}
    {% if status %}
    <p class="status">{{ status }}</p>
    {% endif %}
    <div id="device-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="device-modal-title">
      <div class="modal-content">
        <h2 id="device-modal-title">Choose a device</h2>
        <p>Select a Chromecast device to begin casting.</p>
        <ul id="device-list"></ul>
        <button id="device-cancel" type="button">Cancel</button>
      </div>
    </div>
    <script>
      (() => {
        const videoOptions = Array.from(document.querySelectorAll(".video-option"));
        if (!videoOptions.length) {
          return;
        }

        const modal = document.getElementById("device-modal");
        const deviceList = document.getElementById("device-list");
        const cancelButton = document.getElementById("device-cancel");
        let activeCastUrl = "";

        const hideModal = (resetActiveCastUrl = true) => {
          if (!modal) {
            return;
          }
          modal.classList.add("hidden");
          if (deviceList) {
            deviceList.innerHTML = "";
          }
          if (resetActiveCastUrl) {
            activeCastUrl = "";
          }
        };

        const redirectToCast = (targetUrl, device) => {
          if (!targetUrl) {
            return;
          }
          const url = new URL(targetUrl, window.location.origin);
          if (device) {
            url.searchParams.set("device", device);
          }
          window.location.href = url.toString();
        };

        const showModal = (devices) => {
          if (!modal || !deviceList) {
            redirectToCast(activeCastUrl);
            return;
          }
          deviceList.innerHTML = "";
          devices.forEach((device) => {
            const item = document.createElement("li");
            const button = document.createElement("button");
            button.type = "button";
            button.textContent = device;
            button.addEventListener("click", () => {
              hideModal(false);
              redirectToCast(activeCastUrl, device);
            });
            item.appendChild(button);
            deviceList.appendChild(item);
          });
          modal.classList.remove("hidden");
        };

        const handleCastClick = async (event) => {
          event.preventDefault();
          const option = event.currentTarget;
          if (!(option instanceof HTMLElement)) {
            return;
          }
          const targetUrl = option.getAttribute("data-cast-url") || option.getAttribute("href");
          if (!targetUrl) {
            return;
          }
          activeCastUrl = targetUrl;
          try {
            const response = await fetch("{{ devices_url }}");
            if (!response.ok) {
              throw new Error("Failed to load devices");
            }
            const payload = await response.json();
            const devices = Array.isArray(payload.devices) ? payload.devices : [];
            if (devices.length <= 1) {
              hideModal(false);
              redirectToCast(activeCastUrl, devices[0]);
              return;
            }
            showModal(devices);
          } catch (error) {
            console.error(error);
            hideModal(false);
            redirectToCast(activeCastUrl);
          }
        };

        videoOptions.forEach((option) => {
          option.addEventListener("click", handleCastClick);
        });

        if (cancelButton) {
          cancelButton.addEventListener("click", () => {
            hideModal();
          });
        }

        if (modal) {
          modal.addEventListener("click", (event) => {
            if (event.target === modal) {
              hideModal();
            }
          });
        }
      })();
    </script>
  </body>
</html>
