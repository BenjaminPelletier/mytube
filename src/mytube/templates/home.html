<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>MyTube Remote</title>
    <link rel="stylesheet" href="{{ url_for('static', path='home.css') }}">
  </head>
  <body>
    <h1>MyTube Remote</h1>
    <p class="description">Kick off the featured recommendation on your Chromecast.</p>
    <section class="now-playing" aria-live="polite" hidden>
      <p class="caption">Playing:</p>
      <img class="thumbnail" alt="" hidden>
      <p class="title" hidden></p>
      <p class="status-message" hidden></p>
      <div class="playback-controls" hidden>
        <button type="button" class="playback-button resume-button" aria-label="Resume video">‚ñ∂</button>
        <button type="button" class="playback-button pause-button" aria-label="Pause video">‚è∏</button>
      </div>
    </section>
    <section class="video-options" aria-live="polite">
      <button
        id="refresh-videos"
        class="video-option refresh-option"
        type="button"
        aria-label="Load more videos"
        hidden
      >
        <span class="refresh-icon" aria-hidden="true">üóò</span>
        <span class="refresh-label">More videos</span>
      </button>
    </section>
    <p class="empty-state" id="video-empty">Loading videos‚Ä¶</p>
    <script>
      (() => {
        const videoContainer = document.querySelector(".video-options");
        const refreshButton = document.getElementById("refresh-videos");
        const emptyState = document.getElementById("video-empty");
        const nowPlayingSection = document.querySelector(".now-playing");
        const nowPlayingTitle = nowPlayingSection ? nowPlayingSection.querySelector(".title") : null;
        const nowPlayingThumbnail = nowPlayingSection ? nowPlayingSection.querySelector(".thumbnail") : null;
        const nowPlayingStatus = nowPlayingSection ? nowPlayingSection.querySelector(".status-message") : null;
        const nowPlayingControls = nowPlayingSection ? nowPlayingSection.querySelector(".playback-controls") : null;
        const pauseButton = nowPlayingSection ? nowPlayingSection.querySelector(".pause-button") : null;
        const resumeButton = nowPlayingSection ? nowPlayingSection.querySelector(".resume-button") : null;
        const videosApiUrl = "{{ videos_api_url }}";
        const playApiUrl = "{{ play_api_url }}";
        const pauseApiUrl = "{{ pause_api_url }}";
        const resumeApiUrl = "{{ resume_api_url }}";

        const playbackButtons = [];
        if (pauseButton instanceof HTMLButtonElement) {
          playbackButtons.push(pauseButton);
        }
        if (resumeButton instanceof HTMLButtonElement) {
          playbackButtons.push(resumeButton);
        }

        const setPlaybackControlsDisabled = (isDisabled) => {
          playbackButtons.forEach((button) => {
            button.disabled = Boolean(isDisabled);
            if (isDisabled) {
              button.setAttribute("aria-busy", "true");
            } else {
              button.removeAttribute("aria-busy");
            }
          });
        };

        if (!videoContainer || !videosApiUrl) {
          return;
        }

        const applyNowPlayingDetails = (details = {}) => {
          if (!nowPlayingSection) {
            return;
          }

          const title = typeof details.title === "string" ? details.title : "";
          const thumbnailUrl = typeof details.thumbnail_url === "string" ? details.thumbnail_url : "";
          const videoId = typeof details.video_id === "string" ? details.video_id : "";

          nowPlayingSection.hidden = false;
          nowPlayingSection.dataset.videoId = videoId;

          if (nowPlayingControls) {
            nowPlayingControls.hidden = !videoId;
          }

          if (nowPlayingTitle) {
            if (title) {
              nowPlayingTitle.textContent = title;
              nowPlayingTitle.hidden = false;
            } else {
              nowPlayingTitle.textContent = "";
              nowPlayingTitle.hidden = true;
            }
          }

          if (nowPlayingThumbnail) {
            if (thumbnailUrl) {
              nowPlayingThumbnail.src = thumbnailUrl;
              nowPlayingThumbnail.alt = title ? `Thumbnail for ${title}` : "Thumbnail";
              nowPlayingThumbnail.hidden = false;
            } else {
              nowPlayingThumbnail.removeAttribute("src");
              nowPlayingThumbnail.alt = "";
              nowPlayingThumbnail.hidden = true;
            }
          }
        };

        const setNowPlayingStatus = (message) => {
          if (!nowPlayingStatus) {
            return;
          }
          if (message) {
            nowPlayingStatus.textContent = message;
            nowPlayingStatus.hidden = false;
          } else {
            nowPlayingStatus.textContent = "";
            nowPlayingStatus.hidden = true;
          }
        };

        const setNowPlayingBusy = (isBusy) => {
          if (!nowPlayingSection) {
            return;
          }
          if (isBusy) {
            nowPlayingSection.setAttribute("aria-busy", "true");
          } else {
            nowPlayingSection.removeAttribute("aria-busy");
          }
          setPlaybackControlsDisabled(isBusy);
        };

        const extractErrorMessage = (payload, fallback) => {
          if (payload && typeof payload === "object") {
            const detail = payload.detail || payload.error || payload.message;
            if (typeof detail === "string" && detail) {
              return detail;
            }
          }
          return fallback;
        };

        const handlePlaybackControl = async (apiUrl, pendingMessage, fallbackMessage) => {
          if (!apiUrl) {
            return;
          }

          setNowPlayingStatus(pendingMessage);
          setNowPlayingBusy(true);

          try {
            const response = await fetch(apiUrl, {
              method: "POST",
              headers: { Accept: "application/json" },
            });

            let payload = null;
            try {
              payload = await response.json();
            } catch (error) {
              payload = null;
            }

            if (!response.ok) {
              const message = extractErrorMessage(
                payload,
                response.statusText || fallbackMessage
              );
              setNowPlayingStatus(message || fallbackMessage);
              return;
            }

            setNowPlayingStatus("");
          } catch (error) {
            const message = error instanceof Error ? error.message : fallbackMessage;
            setNowPlayingStatus(message);
            console.error(error);
          } finally {
            setNowPlayingBusy(false);
          }
        };

        const handlePlayVideo = async (event) => {
          event.preventDefault();

          const option = event.currentTarget;
          if (!(option instanceof HTMLElement)) {
            return;
          }

          const videoId = option.dataset.videoId;
          if (!videoId || !playApiUrl) {
            return;
          }

          const pendingDetails = {
            title:
              option.dataset.videoTitle ||
              (option.querySelector(".video-title")?.textContent || ""),
            thumbnail_url:
              option.dataset.thumbnailUrl ||
              (option.querySelector(".video-thumbnail")?.getAttribute("src") || ""),
            video_id: videoId,
          };

          applyNowPlayingDetails(pendingDetails);
          setNowPlayingStatus("Playing...");
          setNowPlayingBusy(true);

          try {
            const response = await fetch(playApiUrl, {
              method: "POST",
              headers: {
                Accept: "application/json",
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ video_id: videoId }),
            });

            let payload = null;
            try {
              payload = await response.json();
            } catch (error) {
              payload = null;
            }

            if (!response.ok) {
              const message = extractErrorMessage(
                payload,
                response.statusText || "Unable to play video."
              );
              setNowPlayingStatus(message);
              return;
            }

            if (payload && typeof payload === "object" && payload.playing) {
              const playingData = payload.playing;
              if (playingData && typeof playingData === "object") {
                applyNowPlayingDetails({
                  title:
                    typeof playingData.title === "string" && playingData.title
                      ? playingData.title
                      : pendingDetails.title,
                  thumbnail_url:
                    typeof playingData.thumbnail_url === "string" && playingData.thumbnail_url
                      ? playingData.thumbnail_url
                      : pendingDetails.thumbnail_url,
                  video_id:
                    typeof playingData.video_id === "string" && playingData.video_id
                      ? playingData.video_id
                      : pendingDetails.video_id,
                });
              }
            }

            setNowPlayingStatus("");
          } catch (error) {
            const message = error instanceof Error ? error.message : "Unable to play video.";
            setNowPlayingStatus(message);
            console.error(error);
          } finally {
            setNowPlayingBusy(false);
          }
        };

        if (pauseButton instanceof HTMLButtonElement) {
          pauseButton.addEventListener("click", (event) => {
            event.preventDefault();
            void handlePlaybackControl(
              pauseApiUrl,
              "Pausing...",
              "Unable to pause playback."
            );
          });
        }

        if (resumeButton instanceof HTMLButtonElement) {
          resumeButton.addEventListener("click", (event) => {
            event.preventDefault();
            void handlePlaybackControl(
              resumeApiUrl,
              "Resuming...",
              "Unable to resume playback."
            );
          });
        }

        const appendRefreshCard = () => {
          if (!videoContainer || !refreshButton) {
            return;
          }
          videoContainer.appendChild(refreshButton);
        };

        const setLoadingState = (isLoading) => {
          if (refreshButton) {
            refreshButton.disabled = isLoading;
            if (isLoading) {
              refreshButton.setAttribute("aria-busy", "true");
            } else {
              refreshButton.removeAttribute("aria-busy");
            }
          }
          if (videoContainer) {
            videoContainer.setAttribute("aria-busy", String(isLoading));
          }
          if (emptyState && isLoading) {
            emptyState.textContent = "Loading videos‚Ä¶";
            emptyState.hidden = false;
          }
        };

        const renderVideos = (videos) => {
          videoContainer.innerHTML = "";
          const validVideos = Array.isArray(videos) ? videos : [];
          if (!validVideos.length) {
            if (emptyState) {
              emptyState.textContent = "No approved videos are available to cast.";
              emptyState.hidden = false;
            }
            appendRefreshCard();
            return;
          }

          const fragment = document.createDocumentFragment();

          validVideos.forEach((video) => {
            if (!video || typeof video !== "object") {
              return;
            }
            const videoId = typeof video.video_id === "string" ? video.video_id : "";
            const thumbnailUrl = typeof video.thumbnail_url === "string" ? video.thumbnail_url : "";
            const title = typeof video.title === "string" ? video.title : "";

            if (!videoId || !thumbnailUrl || !title) {
              return;
            }

            const option = document.createElement("a");
            option.className = "video-option";
            option.href = "#";
            option.setAttribute("role", "button");
            option.dataset.videoId = videoId;
            option.dataset.videoTitle = title;
            option.dataset.thumbnailUrl = thumbnailUrl;

            const thumbnail = document.createElement("img");
            thumbnail.className = "video-thumbnail";
            thumbnail.src = thumbnailUrl;
            thumbnail.alt = `Thumbnail for ${title}`;
            thumbnail.width = 320;

            const label = document.createElement("span");
            label.className = "video-title";
            label.textContent = title;

            option.appendChild(thumbnail);
            option.appendChild(label);
            option.addEventListener("click", handlePlayVideo);

            fragment.appendChild(option);
          });

          videoContainer.appendChild(fragment);
          appendRefreshCard();

          if (emptyState) {
            emptyState.hidden = true;
          }
        };

        const loadVideos = async () => {
          setLoadingState(true);
          try {
            const response = await fetch(videosApiUrl, {
              headers: { Accept: "application/json" },
            });
            if (!response.ok) {
              throw new Error("Failed to load videos");
            }

            const payload = await response.json();
            renderVideos(payload.videos);
          } catch (error) {
            console.error(error);
            videoContainer.innerHTML = "";
            appendRefreshCard();
            if (emptyState) {
              emptyState.textContent = "Unable to load videos.";
              emptyState.hidden = false;
            }
          } finally {
            setLoadingState(false);
            if (refreshButton) {
              refreshButton.hidden = false;
            }
          }
        };

        if (refreshButton) {
          refreshButton.addEventListener("click", () => {
            loadVideos();
          });
        }

        loadVideos();
      })();
    </script>
  </body>
</html>
