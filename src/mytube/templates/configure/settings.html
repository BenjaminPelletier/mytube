{% extends "configure/base.html" %}

{% block content %}
<section class="settings-section">
  <h2>YouTube App Pairing</h2>
  <p>Link MyTube with the YouTube app to cast directly from your TV.</p>
  <div class="pair-status-container">
    {% if lounge_status %}
      {% if lounge_status.connected %}
        <p class="pair-status pair-status--ok">
          Connected to {{ lounge_status.screen_name or lounge_status.name or 'your TV' }}.
        </p>
      {% else %}
        <p class="pair-status pair-status--error">
          {% if lounge_status.error %}
            Unable to connect to the paired TV: {{ lounge_status.error }}
          {% else %}
            Unable to connect to the paired TV.
          {% endif %}
        </p>
      {% endif %}
    {% else %}
      <p class="pair-status pair-status--unknown">No paired TV detected.</p>
    {% endif %}
  </div>
  <form id="youtube-pair-form" class="pair-form" novalidate>
    <label class="pair-label" for="youtube-link-code">Link with TV code</label>
    <div class="pair-fields">
      <input
        id="youtube-link-code"
        name="link_code"
        class="pair-input"
        type="text"
        autocomplete="off"
        placeholder="XXX XXX XXX XXX"
        required
      >
      <button type="submit" id="youtube-pair-button" class="pair-button">Pair</button>
    </div>
    <p class="settings-help">Find the code in the YouTube app under Settings â†’ Link with TV code.</p>
  </form>
  <dialog id="settings-error-dialog" class="settings-modal" aria-labelledby="settings-error-title">
    <form method="dialog" class="settings-modal-content">
      <h3 id="settings-error-title">Pairing error</h3>
      <p id="settings-error-message"></p>
      <button type="submit" value="close" class="settings-modal-close">Close</button>
    </form>
  </dialog>
</section>
<script>
  (function () {
    const settings = {{ settings | tojson }};
    const pairEndpoint = {{ pair_url | tojson }};
    const preferredRaw = settings && typeof settings.preferred_device === 'string'
      ? settings.preferred_device
      : '';
    const preferred = preferredRaw.trim();

    const pairForm = document.getElementById('youtube-pair-form');
    if (!pairForm) {
      return;
    }

    const codeInput = document.getElementById('youtube-link-code');
    const pairButton = document.getElementById('youtube-pair-button');
    const errorDialog = document.getElementById('settings-error-dialog');
    const errorMessage = document.getElementById('settings-error-message');

    const setButtonState = (label, disabled) => {
      if (pairButton) {
        pairButton.textContent = label;
        pairButton.disabled = !!disabled;
      }
    };

    const showError = (message) => {
      const fallback = message && typeof message === 'string'
        ? message
        : 'Unable to pair with the YouTube app.';
      if (errorDialog && typeof errorDialog.showModal === 'function') {
        errorMessage.textContent = fallback;
        try {
          errorDialog.showModal();
        } catch (showError) {
          window.alert(fallback);
        }
      } else {
        window.alert(fallback);
      }
    };

    pairForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (!codeInput || !pairButton) {
        return;
      }
      const code = codeInput.value.trim();
      if (!code) {
        showError('Enter the code displayed on your TV.');
        codeInput.focus();
        return;
      }
      const originalLabel = pairButton.dataset.originalLabel || pairButton.textContent || 'Pair';
      pairButton.dataset.originalLabel = originalLabel;
      setButtonState('Pairing...', true);
      try {
        const response = await fetch(pairEndpoint, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({code})
        });
        if (!response.ok) {
          let detail = 'Unable to pair with the YouTube app.';
          try {
            const payload = await response.json();
            if (payload && typeof payload.detail === 'string') {
              detail = payload.detail;
            }
          } catch (ignore) {}
          throw new Error(detail);
        }
        setButtonState('Paired!', true);
        if (codeInput) {
          codeInput.disabled = true;
        }
      } catch (error) {
        setButtonState(pairButton.dataset.originalLabel || 'Pair', false);
        showError(error && typeof error.message === 'string' ? error.message : 'Unable to pair with the YouTube app.');
      }
    });
  })();
</script>
{% endblock %}
